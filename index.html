<!DOCTYPE html>
<html>
  <head>
    <title>Containers-pres</title>
    <meta charset="utf-8">
    <style>
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle

# Containers

![dockerdevil](https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQFSQbmdcdS4oZ9r8mm4bqbHwo5vU17ftTN0VtjqoR81cel9c0sdg)

---

# Why?

 - Developers like it
 - Clear divorce of build/deploy
 - Unified way to deploy apps
 - Logical isolation in seconds

---

# Shit we use to get there!

 - CoreOS 
   * fleet
   * etcd
   * docker
 - SystemD
 - JournalD
 - Vulcan

And a little bit of:

 - Sky dns
 - Good ol' Bash
 - Golang services
 - Cadvisor
 - Prometheus

---

# What it looks like?

---

# Docker file

Example dropwizard service

```bash
FROM coco/javabase

RUN git clone http://git.svc.ft.com/scm/cp/wordpress-article-transformer.git
RUN cd wordpress-article-transformer && mvn install
RUN cp /wordpress-article-transformer/target/wordpress-article-transformer-0.0.1-SNAPSHOT.jar /app.jar

ADD credentials.properties /
ADD config.yaml /

CMD java -jar app.jar server config.yaml
``` 

---

# Service file

```bash
[Unit]
Description=Wordpress Transformer
After=docker.service
Requires=docker.service

[Service]
TimeoutStartSec=300
ExecStartPre=-/usr/bin/docker kill %p-%i
ExecStartPre=-/usr/bin/docker rm %p-%i
ExecStartPre=/usr/bin/docker pull coco/wp-transformer
ExecStart=/usr/bin/docker run --rm --name %p-%i -p 8080 -p 8081 coco/wp-transformer
ExecStop=/usr/bin/docker stop -t 3 %p-%i
Restart=on-failure
RestartSec=60

[X-Fleet]
Conflicts=%p@*.service
```

---

# Fleetctl

```bash
fleetctl start wp-transformer@1.service
```

---

# Splunk intergration

A Service file which does:

```bash
...
ExecStart=/bin/bash -c "\
  export SPLUNK_IP=$(/usr/bin/etcdctl get /ft/splunk_host); \
  /usr/bin/journalctl -a -f --output=json | ncat $SPLUNK_IP 514"
...
```
[Splunk](http://ec2-52-17-39-186.eu-west-1.compute.amazonaws.com:8000/en-US/app/search/search?q=search%20source%3D%22tcp%3A514%22&earliest=&latest=&sid=1432734408.7)

---

# Host + Container metrics

A docker container:
```bash
...
ExecStart=/usr/bin/docker run --rm --volume=/:/rootfs:ro 
  --volume=/var/run:/var/run:rw 
  --volume=/sys:/sys:ro --volume=/var/lib/docker/:/var/lib/docker:ro 
  --publish=8081:8080 --name=cadvisor google/cadvisor:latest
...
```

[Cadvisor](http://ec2-52-17-39-186.eu-west-1.compute.amazonaws.com:8081/containers/)

---

# SkyDNS

Service:
```bash
docker run --rm --net=host -e SKYDNS_NAMESERVERS='172.31.0.2:53' 
  -e SKYDNS_ADDR=$DOCKER_IP:53 -e ETCD_MACHINES='http://127.0.0.1:4001' 
  --name %p skynetservices/skydns"
```

Sidekicks:
```bash
export HOST_IP=$(/usr/bin/ifconfig eth0 | sed -n '2 p' | awk '{print $2}' | cut -d':' -f2); \
  export HOST_NAME=$(echo $HOSTNAME | cut -d '.' -f1); \
  while true; do \
    etcdctl set /skydns/local/skydns/cadvisor/$HOST_NAME 
    \"{\\\"host\\\":\\\"$HOST_IP\\\",\\\"port\\\":8081}\" --ttl 60; \
    sleep 45; \
  done"
```

---

# Prometheus

[Prometheus](http://54.77.7.111:9090/)

```
sum(rate(container_cpu_usage_seconds_total{name="cadvisor"}[2m]) * 100) by (name, instance)
```

---

# PromDash

[PromDash](http://54.77.7.111:3000/test1)

---

# The big TODO

 - Deployments (scheduler service)
 - docker image rebuilding
 - docker repo
 - VM scaling strategy
 - docs
 - unhacking things
 - "environments"
 - **actual** monitoring
 - training
 - migration
 - testing, lots of testing
 - ...
 - ..
 - .

---

# Links:

 - [CoreOS](https://coreos.com/)
 - [Fleet](https://github.com/coreos/fleet)
 - [etcd](https://github.com/coreos/etcd)
 - [Dockerfiles](http://docs.docker.com/reference/builder/)
 - [SystemD](http://freedesktop.org/wiki/Software/systemd/)
 - [JournalD](http://www.freedesktop.org/software/systemd/man/systemd-journald.service.html)
 - [vulcan](http://vulcand.io/)
 - [SkyDNS](https://github.com/miekg/skydns2)
 - [Cadvisor](https://github.com/google/cadvisor)
 - [Prometheus](http://prometheus.io/)
 - [PromDash](https://github.com/prometheus/promdash/)

    </textarea>
    <script src="https://gnab.github.io/remark/downloads/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create();
    </script>
  </body>
</html>
